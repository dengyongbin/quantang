package com.quantang.web.article;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.io.Writer;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;

import org.apache.commons.io.IOUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.commons.CommonsMultipartFile;
import org.springframework.web.servlet.view.freemarker.FreeMarkerConfigurer;

import com.quantang.dao.impl.SystemDaoImpl;
import com.quantang.domain.Article;
import com.quantang.service.ArticleService;

import freemarker.template.Configuration;
import freemarker.template.Template;
import freemarker.template.TemplateException;

/**
 * å’¨è¯¢viewæ§åˆ¶ç±?
 * 
 * @author yangjian
 * 
 */
@Controller
public class ArticleController {

	@Autowired
	private ArticleService articleService;

	@Autowired
	private FreeMarkerConfigurer freeMarkerConfigurer;

	@Autowired
	private SystemDaoImpl system;
	
	/**
	 * @return String
	 * @todo è·³è½¬åˆ°æ–°å¢æ–‡ç« é¡µ
	 */
	@RequestMapping("/addarticle.htm")
	public String addacticle() {
		return "/article/article";
	}

	/**
	 * @param article
	 * @return String
	 * @todo ä¿å­˜æ–‡ç« 
	 */
	@RequestMapping("/savearticle.htm")
	public String savearticle(HttpServletRequest request, @RequestParam("fileUpload") CommonsMultipartFile file,
			Article article) {
		if (!file.isEmpty()) {
			String path = request.getSession().getServletContext().getRealPath("/") + "photo/"
					+ file.getOriginalFilename();
			File localFile = new File(path);
			try {
				file.transferTo(localFile);
				article.setImage("/photo/" + file.getOriginalFilename());
			} catch (IllegalStateException e) {
				e.printStackTrace();
			} catch (IOException e) {
				e.printStackTrace();
			}
		}
		articleService.addArticle(article);
		return "redirect:/articleidx.htm";
	}

	/**
	 * @param mm
	 * @return String
	 * @todo æ–‡ç« åˆ—è¡¨é¡?
	 */
	@RequestMapping("/articleidx.htm")
	public String articlelist(ModelMap mm) {
		List<Map<String, Object>> articleList = articleService.findAllArticle();
		mm.addAttribute("articleList", articleList);
		return "article/articlelist";
	}

	/**
	 * @param id
	 * @param mm
	 * @return String
	 * @todo å–å¾—æ–‡ç« é ?
	 */
	@RequestMapping("/article.htm")
	public String article(@RequestParam String id, ModelMap mm) {
		Map<String, Object> articleMap = articleService.findArticleById2(id);
		mm.addAllAttributes(articleMap);
		return "article/article";
	}

	/**
	 * @param infomationType
	 * @param infomationStatus
	 * @param timing
	 * @param timing1
	 * @param ids
	 * @return String
	 * @todo åˆ é™¤æ–‡ç« 
	 */
	@RequestMapping("/articleDelete.htm")
	public String articleDelete(@RequestParam String ids) {
		articleService.delArticle(ids);
		return "redirect:/articleidx.htm";
	}

	/**
	 * @param infomationType
	 * @param infomationStatus
	 * @param timing
	 * @param timing1
	 * @param id
	 * @return String
	 * @todoã€?–‡ç« å‘å¸?
	 */
	@RequestMapping("/articlePublish.htm")
	public String articlePublish(@RequestParam String infomationType, @RequestParam String infomationStatus,
			@RequestParam String timing, @RequestParam String timing1, @RequestParam String id) {
		articleService.pubArticle(id);
		return "redirect:/articleidx.htm";
	}

	/**
	 * å‘å¸ƒæ–°é—»
	 * 
	 * @param request
	 * @param id
	 * @return
	 */
	@RequestMapping("/push.htm")
	public String pushArticle(HttpServletRequest request, @RequestParam int id) {
		Map<String, Object> articleMap = articleService.findArticleById2(id + "");
		// æ–‡ä»¶å‰ç¼€å?
		//int maxCount = articleService.findMaxCount();
		int maxCount = system.getNewsCount();
		// é™æ?æ–‡ä»¶å­˜æ”¾è·¯å¾„
		String newsPath = request.getSession().getServletContext().getRealPath("/") + "news/" + maxCount + ".html";
		Configuration configuration = freeMarkerConfigurer.getConfiguration();
		Template template;
		try {
			// æ–‡ä»¶æ¨¡ç‰ˆ
			template = configuration.getTemplate("news.ftl", "UTF-8");
			File file = new File(newsPath);
			// åŠ¨æ?å®ä½“è®¾ç½®å±æ?å€?
			Article article = new Article();
			article.setTitle(String.valueOf(articleMap.get("title")));
			article.setContent(String.valueOf(articleMap.get("content")));
			article.setAuthor(String.valueOf(articleMap.get("author")));
			article.setTiming(String.valueOf(articleMap.get("timing")));
			Map<String, Object> paramMap = new HashMap<String, Object>();
			Map<String, Article> rootMap = new HashMap<String, Article>();
			rootMap.put("article", article);
			template.setCustomAttribute("base", request.getSession().getServletContext().getAttribute("base"));
			paramMap.put("base", request.getSession().getServletContext().getAttribute("base"));
			paramMap.put("article", article);
			// è¾“å‡ºæ¨¡ç‰ˆå†…å®¹
			Writer out = new OutputStreamWriter(new FileOutputStream(file), "UTF-8");
			template.process(paramMap, out);
			IOUtils.closeQuietly(out);
			// æ›´æ–°æ–°é—»å®ä½“çŠ¶æ?å’Œé™æ€é¡µå±æ?å€?
			articleService.uptArticle(id, "/news/" + maxCount + ".html");
			system.updateNewsCount(maxCount+1);
		} catch (IOException e) {
			e.printStackTrace();
		} catch (TemplateException e) {
			e.printStackTrace();
		}
		return "redirect:/articleidx.htm";
	}
}
